name: Auto ACB Newsletter

on:
  schedule:
    - cron: '0 * * * *' # Cada hora en punto
  workflow_dispatch: # Botón manual para probar

permissions:
  contents: write # IMPORTANTE

jobs:
  run-process:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      # Asegura que instale todo lo que usan tus scripts
      run: |
        pip install requests pandas beautifulsoup4 google-generativeai markdown

    - name: Ejecutar Check Status
      env:
        # Secretos necesarios para toda la cadena
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
        URL_SUSCRIPTORES: ${{ secrets.URL_SUSCRIPTORES }}
        MAKE_WEBHOOK_URL: ${{ secrets.MAKE_WEBHOOK_URL }}
      run: python check_status.py
      
- name: Guardar cambios en Data
      run: |
        git config --global user.name 'ACB Bot'
        git config --global user.email 'bot@noreply.github.com'
        
        # 1. Nos traemos cambios remotos primero para evitar conflictos
        git pull --rebase origin main || git pull --rebase origin master
        
        # 2. Añadimos todo lo nuevo en data
        git add data/
        
        # 3. Solo hacemos commit si hay algo nuevo
        if git diff --staged --quiet; then
          echo "✅ No hay cambios que guardar."
        else
          git commit -m "Auto: Update Data & Status [skip ci]"
          # 4. Intentamos subir. Si falla, es mejor que falle el action para que te avise.
          git push
        fi
